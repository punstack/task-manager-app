{% extends "layout.html" %}
{% block title %}Task Manager - {{ user }}{% endblock %}

{% block home_status %}{% endblock %}
{% block user_status %}active{% endblock %}
{% block settings_status %}{% endblock %}
{% block add_status %}{% endblock %}

{% block content %}
<div class="position-relative m-md-3">
  <div>
    <h1 class="h3 mb-3 display-4 font-weight-normal text-center">{{ user }}'s Tasks</h1>
  </div>
  {% for task in tasks %}
  <span {% if task.completed %} style="text-decoration: line-through" {% endif %}>
    <div class="task">
      <input type="checkbox" class="task-checkbox" {% if task.completed %}checked{% endif %} onclick="updateTaskStatus(this, {{ task.id }})">
      <span class="task-name">{{ task.title }}</span>
      <div class="task-details">
        {% if task.description %}
        <span class="task-description">{{ task.description }}</span><br>
        {% endif %}
        {% if task.due_date %}
        <span class="task-due-date">{{ task.due_date }}</span><br>
        {% endif %}
        {% for subtask in tasks.subtasks %}
        <input type="checkbox" class="subtask-checkbox" onclick="toggleSubtaskCompletiion({{ subtask.id }})" {% if subtask.completed %}checked{% endif %}>
        <span class="subtask">{{ subtask.title }}</span>
        {% endfor %}
      </div>
    </div>
  </span>
  {% endfor %} 
</div>

<script>
  function updateTaskStatus(checkbox, taskId) {
    fetch(`/update-task-status/${taskId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        checkbox.parentElement.querySelector('.task-name').style.textDecoration = data.completed ? 'line-through' : 'none';
        checkbox.parentElement.style.textDecoration = data.completed ? 'line-through' : 'none';
      } else {
        alert("Failed to update task status.");
      }
    });
  }

  function toggleSubtaskCompletion(subtaskId) {
    fetch(`/toggle-subtask/${subtaskId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        checkbox.parentElement.querySelector('.task-name').style.textDecoration = data.completed ? 'line-through' : 'none';
      } else {
        alert("Failed to update task status.");
      }
    });
  }
</script> 
{% endblock %}